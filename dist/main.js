(()=>{var e={409:e=>{"use strict";e.exports=require("./drm.js")},933:e=>{"use strict";e.exports=require("electron")},747:e=>{"use strict";e.exports=require("fs")},622:e=>{"use strict";e.exports=require("path")}},o={};function t(n){var s=o[n];if(void 0!==s)return s.exports;var r=o[n]={exports:{}};return e[n](r,r.exports,t),r.exports}(()=>{const e=t(622),o=t(747),{ipcRenderer:n}=t(933),s=t(933),r=s.app,a=s.BrowserWindow,i=s.ipcMain,{drmEmitter:l,removeBookDrms:u}=t(409),c=l.drmEvents,d=e.dirname(r.getPath("userData")),p=e.join(d,"Ridibooks"),w=e.join(p,"datastores","global"),g=e.join(p,"datastores","user"),b=`${r.getPath("userData")}/state.json`;let D;D=o.existsSync(b)?JSON.parse(o.readFileSync(b)):{};const h=s.Menu.buildFromTemplate([]);s.Menu.setApplicationMenu(h);let f=null;const m={width:450,height:300,resizable:!1,maximizable:!1,fullscreenable:!1,titleBarStyle:"hidden",autoHideMenuBar:!0,webPreferences:{nodeIntegration:!0,contextIsolation:!1,devTools:!1}};let S=D.outputDir||r.getPath("userData");i.on("select-output-dir",(async(o,t)=>{const n=await s.dialog.showOpenDialog(f,{properties:["openDirectory"]});!n.canceled&&n.filePaths[0]&&(S=e.resolve(n.filePaths[0])),console.log("SELECTED DIR: ",n),o.reply("selected-output-dir",S)})),i.on("get-output-dir",(e=>{e.returnValue=S})),l.on(c.taskStart,(function(e){const o=Object.values(e),t=o.length,n=o.reduce(((e,o)=>(e.push.apply(e,o.books),e)),[]).length;console.log(`[TASK START] ${t} users, ${n} books.`),f.webContents.send(c.taskStart,t,n)})),l.on(c.onNewUser,(function(e,o){const t=o.length;console.log(`[ON NEW USER] ${e}`),f.webContents.send(c.onNewUser,e,t)})),l.on(c.onNewBook,(function(e){console.log(`[ON NEW BOOK] ${e}`),f.webContents.send(c.onNewBook,e)})),l.on(c.taskDone,(function(){console.log("[TASK DONE]"),f.webContents.send(c.taskDone,S)})),l.on(c.beforeTaskDone,(function(){console.log("[BEFORE TASK DONE]"),f.webContents.send(c.beforeTaskDone)})),l.on(c.noData,(function(){f.webContents.send(c.noData)})),i.on("run",(function(e){o.existsSync(w)&&o.existsSync(g)?(u(p,S),console.log("[IM IN MAIN]")):f.webContents.send(c.noData)})),i.on("show-output-dir",(e=>{s.shell.openPath(S)})),i.on("log",((e,...o)=>{console.log(...o)})),r.on("ready",(()=>{console.log("[ELECTRON READY]"),f=new a(m),f.webContents.loadURL(`file://${__dirname}/index.html`),s.globalShortcut.register("CommandOrControl+I",(()=>{f.webContents.openDevTools()})),l.emit(c.launch,p)}));const x=new Promise((e=>{l.on(c.allDone,e)}));r.on("window-all-closed",(async e=>{await x,D={outputDir:S},o.writeFileSync(b,JSON.stringify(D)),r.quit()}))})(),module.exports={}})();